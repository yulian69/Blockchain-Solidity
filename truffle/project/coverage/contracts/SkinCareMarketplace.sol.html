<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\SkinCareMarketplace.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> SkinCareMarketplace.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>52/52</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">80.77% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>21/26</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>30/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>60/60</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">44×</span>
<span class="cline-any cline-yes">44×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.4.24;
&nbsp;
import "./Ownable.sol";
import "./SafeMath.sol";
import "./LibSkinCareMarketplace.sol";
import "./ERC20Interface.sol";
import "./ApproveAndCallFallBack.sol";
&nbsp;
contract SkinCareMarketplace is ApproveAndCallFallBack, Ownable {
    using LibSkinCareMarketplace for LibSkinCareMarketplace.MarketplaceData; 
    LibSkinCareMarketplace.MarketplaceData marketplaceData; 
    
    using SafeMath for uint;
    using SafeMath for bytes;
    
    event AddSeller(bytes32 indexed sellerId, string ipfs, uint timestamp);
    event UpdateSeller(bytes32 indexed sellerId, string ipfs, uint timestamp);
    
    event AddBuyer(bytes32 indexed buyerId, string ipfs, uint timestamp);
    event UpdateBuyer(bytes32 indexed buyerId, string ipfs, uint timestamp);
    
    event BuyItem(bytes32 indexed buyerId, bytes32 indexed sellerId, uint indexed day, bytes32 itemId, uint quantity, uint amount, uint timestamp);
    event AddItem(bytes32 indexed itemId, bytes32 indexed sellerId, string ipfs, uint price, uint quantity, uint timestamp);
    event UpdateItem(bytes32 indexed itemId, bytes32 indexed sellerId, string ipfs, uint price, uint quantity, uint timestamp);
   
    event TransferTokens(address addr, uint tokens, uint timestamp);
     
    modifier onlyNewSeller(address sender) {
        require(!marketplaceData.sellers[marketplaceData.sellerAddresses[sender]].exist);
        _;
    }
    
    modifier onlyExistingSeller() {
        require(marketplaceData.sellers[marketplaceData.sellerAddresses[msg.sender]].exist);
        _;
    }
    
    modifier onlyNewBuyer() {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(!marketplaceData.buyers[marketplaceData.buyerAddresses[msg.sender]].exist);
        _;
    }
    
    modifier onlyExistingBuyer(address sender) {
        require(marketplaceData.buyers[marketplaceData.buyerAddresses[sender]].exist);
        _;
    }
    
    modifier onlyExistingItem(bytes32 itemId) {
        require(marketplaceData.items[itemId].exist &amp;&amp; marketplaceData.items[itemId].sellerId == marketplaceData.sellerAddresses[msg.sender]);
        _;
    }
    
    modifier onlyToken(address _tokenAddress) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(tokenAddress == _tokenAddress);
        _;
    }
    
    address tokenAddress;
    uint registerPrice;
    
    function () public payable {
        revert();
    }
    
    constructor(address _tokenAddress) public {
        tokenAddress = _tokenAddress;
        registerPrice = 20000;
    }
   
    function addSeller(address sender, string ipfs) internal onlyNewSeller(sender) {
        transferRegisterTokens(sender);
        marketplaceData.addSeller(sender, ipfs);
        emit AddSeller(marketplaceData.sellerAddresses[sender], ipfs, now);
    }
    
    function updateSeller(string ipfs) public onlyExistingSeller {
        marketplaceData.updateSeller(ipfs);
        emit UpdateSeller(marketplaceData.sellerAddresses[msg.sender], ipfs, now);
    }
    
    function getSellerByAddress() public view returns(bytes32, string) {
        return marketplaceData.getSellerByAddress();
    }
    
    function getSellerById(bytes32 sellerId) public view returns(address, string) {
        return marketplaceData.getSellerById(sellerId);
    }
    
    function getSellers() public view returns(bytes32[]) {
        return marketplaceData.ar_sellers;
    }
    
    function addItem(string ipfs, uint price, uint quantity) public onlyExistingSeller {
        bytes32 itemId = marketplaceData.addItem(ipfs, price, quantity);
        emit AddItem(itemId, marketplaceData.getSellerId(), ipfs, price, quantity, now);
    }
    
    function updateItem(bytes32 itemId, string ipfs, uint price, uint quantity) public onlyExistingItem(itemId) {
        marketplaceData.updateItem(itemId, ipfs, price, quantity);
        emit UpdateItem(itemId, marketplaceData.getSellerId(), ipfs, price, quantity, now);
    }
    
    function getItem(bytes32 itemId) public view returns(string,uint,uint) {
        return marketplaceData.getItem(itemId);
    }
    
    function getItems(bytes32 sellerId) public view returns(bytes32[]) {
        return marketplaceData.sellers[sellerId].items;
    }
   
    function getBuyerByAddress() public view returns(bytes32, string) {
        return marketplaceData.getBuyerByAddress();
    }
    
    function getBuyer(bytes32 buyerId) public view returns(address, string) {
        return marketplaceData.getBuyerById(buyerId);
    }
    
    function updateBuyer(string ipfs) public onlyExistingBuyer(msg.sender) {
        marketplaceData.updateBuyer(ipfs);
        emit UpdateBuyer(marketplaceData.getBuyerId(), ipfs, now);
    }
    
    function registerAndBuy(address sender, string ipfs, bytes32 itemId, uint tokens) onlyNewBuyer internal {
        bytes32 buyerId = marketplaceData.registerBuyer(sender, ipfs);
        emit AddBuyer(buyerId, ipfs, now);
        buy(sender, itemId, tokens);
    }
    
    function buy(address sender, bytes32 itemId, uint tokens) internal onlyExistingBuyer(sender) {
        transferBuyTokens(sender, marketplaceData.getSellerAddressByItemId(itemId), tokens);
        
        uint quantity = marketplaceData.buy(itemId, tokens);
        bytes32 sellerId = marketplaceData.getSellerIdByItemId(itemId);
       
        emit BuyItem(marketplaceData.buyerAddresses[sender], sellerId, now/3600, itemId, quantity, tokens, now);
    }
    
    function receiveApproval(address sender, uint tokens, address _tokenAddrress, bytes data) public onlyToken(_tokenAddrress) {
        require(data.length &gt;= 1);
        
        if ( data[data.length-1] == byte(1) ) {
            <span class="missing-if-branch" title="else path not taken" >E</span>require(tokens &gt;= registerPrice);
            addSeller(sender, string(data.bytesToBytes(0,data.length-1)));
        } else if ( data[data.length-1] == byte(2) ) {
            <span class="missing-if-branch" title="else path not taken" >E</span>require(data.length &gt;= 34);
            registerAndBuy(sender, string(data.bytesToBytes(32,data.length-33)), data.bytesToBytes32(0), tokens);
        } else if ( data[data.length-1] == byte(3) ) {
            <span class="missing-if-branch" title="else path not taken" >E</span>require(data.length &gt;= 33);
            buy(sender, data.bytesToBytes32(0), tokens);
        } else {
            revert();
        }
    }
    
    function setTokenAddress(address _tokenAddress) public onlyOwner {
        tokenAddress = _tokenAddress;
    }
    
    function getTokenAddress() public view returns(address) {
        return tokenAddress;
    }
    
    function transferTokens(address addr, uint tokens) public onlyOwner {
        ERC20Interface(tokenAddress).transfer(addr, tokens);
        emit TransferTokens(addr, tokens, now);
    }
    
    function transferRegisterTokens(address sender) internal {
        ERC20Interface(tokenAddress).transferFrom(sender, address(this), registerPrice);
    }
    
    function transferBuyTokens(address sender, address seller, uint tokens) internal {
        uint sellerTokens = tokens.mul(95).div(100);
        
        ERC20Interface(tokenAddress).transferFrom(sender, address(this), tokens);
        ERC20Interface(tokenAddress).transfer(seller, sellerTokens);
    }
    
    function transferAllTokens() public onlyOwner {
        transferTokens(owner, ERC20Interface(tokenAddress).balanceOf(address(this)));
    }
    
    function kill() public onlyOwner {
        transferAllTokens();
        selfdestruct(owner);
    }
}
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sat Jul 14 2018 16:52:06 GMT+0300 (FLE Daylight Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
